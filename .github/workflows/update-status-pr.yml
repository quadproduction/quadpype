name: Update Ticket Status in GitHub Project

on:
  pull_request:
    types: [closed]

jobs:
  update-project-status:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      pull-requests: read

    steps:
      - name: Parse PR and update Project status
        uses: actions/github-script@v7
        with:
          # Use PROJECT_TOKEN if available, otherwise fallback to GITHUB_TOKEN
          github-token: ${{ secrets.PROJECT_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const prBody = context.payload.pull_request.body || '';
            console.log('PR Body:', prBody);

            // Regex to capture a complete line with potentially multiple tickets
            // Example: "Ticket #280 #277 #300 Update to Deployed"
            const lineRegex = /Ticket\s*:?\s*((?:#\d+\s*)+)\s*Update(?:\s+status)?(?:\s+to)?\s*:?\s*([^\n,\-â€¢]+)/gi;
            const lines = [...prBody.matchAll(lineRegex)];

            if (lines.length === 0) {
              console.log('No tickets found with expected syntax');
              return;
            }

            // For each line found, extract all ticket numbers
            const ticketUpdates = [];
            for (const line of lines) {
              const ticketsString = line[1]; // Ex: "#280 #277 #300 "
              const newStatus = line[2].trim();

              // Extract all ticket numbers from this line
              const ticketNumbers = [...ticketsString.matchAll(/#(\d+)/g)].map(m => m[1]);

              // Add each ticket with its status
              for (const ticketNumber of ticketNumbers) {
                ticketUpdates.push({ number: ticketNumber, status: newStatus });
              }
            }

            console.log(`ðŸ“‹ ${ticketUpdates.length} ticket(s) to update`);

            for (const { number: issueNumber, status: newStatus } of ticketUpdates) {

              console.log(`Processing ticket #${issueNumber} with status: ${newStatus}`);

              try {
                // 1. Retrieve the global ID of the issue and ALL its projects
                const issueQuery = `
                  query($owner: String!, $repo: String!, $number: Int!) {
                    repository(owner: $owner, name: $repo) {
                      issue(number: $number) {
                        id
                        title
                        projectItems(first: 50) {
                          nodes {
                            id
                            project {
                              id
                              title
                              number
                            }
                          }
                        }
                        projectsV2(first: 50) {
                          nodes {
                            id
                            title
                          }
                        }
                      }
                    }
                  }
                `;

                const issueData = await github.graphql(issueQuery, {
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  number: parseInt(issueNumber)
                });

                const issue = issueData.repository.issue;
                console.log(`ðŸ“‹ Ticket #${issueNumber}: "${issue.title}"`);
                console.log(`ðŸ” Projects V2 found:`, issue.projectsV2.nodes.length);
                console.log(`ðŸ” Project Items found:`, issue.projectItems.nodes.length);

                // Display details for debugging
                if (issue.projectsV2.nodes.length > 0) {
                  console.log('Projects V2:', issue.projectsV2.nodes.map(p => p.title).join(', '));
                }
                if (issue.projectItems.nodes.length > 0) {
                  console.log('Project Items:', issue.projectItems.nodes.map(p => p.project.title).join(', '));
                }

                const projectItems = issue.projectItems.nodes;

                if (projectItems.length === 0) {
                  console.log(`âš ï¸ Ticket #${issueNumber} is not associated with any V2 project`);
                  console.log(`â„¹ï¸ Please verify that:`);
                  console.log(`   1. The ticket is in a GitHub Projects (V2/beta)`);
                  console.log(`   2. The token has "project" permissions (read/write)`);
                  console.log(`   3. It's not a "Classic Project" (not supported)`);
                  continue;
                }

                // 2. For each associated project
                for (const projectItem of projectItems) {
                  const projectId = projectItem.project.id;
                  const projectTitle = projectItem.project.title;
                  const itemId = projectItem.id;

                  console.log(`Updating in project: ${projectTitle}`);

                  // 3. Retrieve project fields (especially the Status field)
                  const projectFieldsQuery = `
                    query($projectId: ID!) {
                      node(id: $projectId) {
                        ... on ProjectV2 {
                          fields(first: 20) {
                            nodes {
                              ... on ProjectV2SingleSelectField {
                                id
                                name
                                options {
                                  id
                                  name
                                }
                              }
                            }
                          }
                        }
                      }
                    }
                  `;

                  const projectData = await github.graphql(projectFieldsQuery, {
                    projectId: projectId
                  });

                  // 4. Find the "Status" field and the corresponding option
                  const fields = projectData.node.fields.nodes;
                  const statusField = fields.find(f => f.name === 'Status');

                  if (!statusField) {
                    console.log(`âš ï¸ No "Status" field found in project ${projectTitle}`);
                    console.log('Available fields:', fields.map(f => f.name).join(', '));
                    continue;
                  }

                  const statusOption = statusField.options.find(
                    opt => opt.name.toLowerCase() === newStatus.toLowerCase()
                  );

                  if (!statusOption) {
                    console.log(`âš ï¸ Status "${newStatus}" does not exist in the project`);
                    console.log('Available statuses:', statusField.options.map(o => o.name).join(', '));
                    continue;
                  }

                  // 5. Update the status
                  const updateMutation = `
                    mutation($projectId: ID!, $itemId: ID!, $fieldId: ID!, $optionId: String!) {
                      updateProjectV2ItemFieldValue(
                        input: {
                          projectId: $projectId
                          itemId: $itemId
                          fieldId: $fieldId
                          value: { singleSelectOptionId: $optionId }
                        }
                      ) {
                        projectV2Item {
                          id
                        }
                      }
                    }
                  `;

                  await github.graphql(updateMutation, {
                    projectId: projectId,
                    itemId: itemId,
                    fieldId: statusField.id,
                    optionId: statusOption.id
                  });

                  console.log(`âœ“ Status updated to "${newStatus}" in project ${projectTitle}`);

                  // 6. Add a comment to the issue
                  await github.rest.issues.createComment({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issueNumber,
                    body: `âœ… Status mis Ã  jour vers **${newStatus}** suite Ã  la merge de la PR #${context.payload.pull_request.number}`
                  });
                }

              } catch (error) {
                console.error(`âœ— Error updating ticket #${issueNumber}:`, error);
                console.error('Details:', error.message);
              }
            }
